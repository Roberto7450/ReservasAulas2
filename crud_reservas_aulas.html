<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema de Reservas de Aulas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Sistema de Reservas de Aulas</h1>

    <!-- Configuración del Servidor -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Configuración</h2>
        <div class="flex gap-4 items-end">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">URL del Servidor</label>
                <input type="text" id="serverUrl" value="http://localhost:8080"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <button onclick="testConnection()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                Probar Conexión
            </button>
        </div>
        <div id="connectionStatus" class="mt-3 text-sm"></div>
    </div>

    <!-- Pestañas -->
    <div class="bg-white rounded-lg shadow-md mb-8">
        <div class="flex border-b">
            <button onclick="showTab('aulas')" id="tab-aulas" class="flex-1 px-6 py-4 text-center font-medium border-b-2 border-blue-600 text-blue-600">
                Aulas
            </button>
            <button onclick="showTab('horarios')" id="tab-horarios" class="flex-1 px-6 py-4 text-center font-medium text-gray-600 hover:text-blue-600">
                Horarios
            </button>
            <button onclick="showTab('reservas')" id="tab-reservas" class="flex-1 px-6 py-4 text-center font-medium text-gray-600 hover:text-blue-600">
                Reservas
            </button>
        </div>
    </div>

    <!-- Sección de Aulas -->
    <div id="section-aulas" class="space-y-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4">Gestión de Aulas</h2>
            <form id="aulaForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="aulaId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre</label>
                    <input type="text" id="aulaNombre" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidad</label>
                    <input type="number" id="aulaCapacidad" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="aulaEsOrdenadores" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label class="ml-2 text-sm font-medium text-gray-700">¿Tiene ordenadores?</label>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Guardar Aula
                    </button>
                    <button type="button" onclick="clearAulaForm()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                        Limpiar
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Filtros</h3>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Capacidad mínima</label>
                    <input type="number" id="filtroCapacidad" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Con ordenadores</label>
                    <select id="filtroOrdenadores" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="loadAulas()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Aplicar Filtros
                    </button>
                    <button onclick="clearFilters()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                        Limpiar
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Lista de Aulas</h3>
            <div id="aulasList" class="overflow-x-auto">
                <p class="text-gray-500 text-center py-4">Cargando aulas...</p>
            </div>
        </div>
    </div>

    <!-- Sección de Horarios -->
    <div id="section-horarios" class="space-y-6 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4">Gestión de Horarios</h2>
            <form id="horarioForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="horarioId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Día de la Semana</label>
                    <select id="horarioDiaSemana" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="LUNES">Lunes</option>
                        <option value="MARTES">Martes</option>
                        <option value="MIERCOLES">Miércoles</option>
                        <option value="JUEVES">Jueves</option>
                        <option value="VIERNES">Viernes</option>
                        <option value="SABADO">Sábado</option>
                        <option value="DOMINGO">Domingo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hora Inicio</label>
                    <input type="time" id="horarioHoraInicio" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hora Fin</label>
                    <input type="time" id="horarioHoraFin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2 flex gap-2">
                    <button type="submit" class="flex-1 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Guardar Horario
                    </button>
                    <button type="button" onclick="clearHorarioForm()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                        Limpiar
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Lista de Horarios</h3>
            <div id="horariosList" class="overflow-x-auto">
                <p class="text-gray-500 text-center py-4">Cargando horarios...</p>
            </div>
        </div>
    </div>

    <!-- Sección de Reservas -->
    <div id="section-reservas" class="space-y-6 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4">Gestión de Reservas</h2>
            <form id="reservaForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="reservaId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Aula</label>
                    <select id="reservaAulaId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccione un aula</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Horario</label>
                    <select id="reservaHorarioId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccione un horario</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha</label>
                    <input type="date" id="reservaFecha" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Asistentes</label>
                    <input type="number" id="reservaAsistentes" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Motivo</label>
                    <input type="text" id="reservaMotivo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2 flex gap-2">
                    <button type="submit" class="flex-1 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        Guardar Reserva
                    </button>
                    <button type="button" onclick="clearReservaForm()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                        Limpiar
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-semibold mb-4">Lista de Reservas</h3>
            <div id="reservasList" class="overflow-x-auto">
                <p class="text-gray-500 text-center py-4">Cargando reservas...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold mb-4">Confirmar Eliminación</h3>
        <p class="text-gray-600 mb-6">¿Está seguro de que desea eliminar este elemento?</p>
        <div class="flex gap-4">
            <button onclick="closeModal()" class="flex-1 px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">
                Cancelar
            </button>
            <button id="confirmDelete" class="flex-1 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Eliminar
            </button>
        </div>
    </div>
</div>

<script>
    // --- Globals ---
    const API_URL = () => document.getElementById('serverUrl').value;
    let aulasData = [];    // caché local de aulas
    let horariosData = []; // caché local de horarios

    // --- Utilidades ---
    function showNotification(message, type = 'success') {
        const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    async function safeText(response) {
        try { return await response.text(); } catch (e) { return null; }
    }
    async function safeJson(response) {
        try { const text = await response.text(); if (!text) return null; return JSON.parse(text); } catch (e) { return null; }
    }

    // --- Pestañas ---
    function showTab(tab) {
        const section = document.getElementById(`section-${tab}`);
        const tabButton = document.getElementById(`tab-${tab}`);
        if (!section || !tabButton) return;

        document.querySelectorAll('[id^="section-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('[id^="tab-"]').forEach(el => {
            el.classList.remove('border-blue-600', 'text-blue-600');
            el.classList.add('text-gray-600');
        });

        section.classList.remove('hidden');
        tabButton.classList.add('border-blue-600', 'text-blue-600');
        tabButton.classList.remove('text-gray-600');

        if (tab === 'aulas') loadAulas();
        if (tab === 'horarios') loadHorarios();
        if (tab === 'reservas') {
            loadReservas();
            loadAulasForSelect();
            loadHorariosForSelect();
        }
    }

    // --- Test conexión ---
    async function testConnection() {
        const statusDiv = document.getElementById('connectionStatus');
        try {
            const response = await fetch(`${API_URL()}/aulas`);
            if (response.ok) {
                statusDiv.innerHTML = '<span class="text-green-600">✓ Conexión exitosa</span>';
                showNotification('Conexión establecida correctamente', 'success');
            } else {
                const txt = await safeText(response);
                statusDiv.innerHTML = '<span class="text-red-600">✗ Error de conexión. Verifique la URL del servidor</span>';
                showNotification(`No se pudo conectar al servidor: ${txt || response.status}`, 'error');
            }
        } catch (error) {
            statusDiv.innerHTML = '<span class="text-red-600">✗ Error de conexión. Verifique la URL del servidor</span>';
            showNotification('No se pudo conectar al servidor', 'error');
        }
    }

    // -------------------------
    // CRUD AULAS
    // -------------------------
    async function loadAulas() {
        const capacidad = document.getElementById('filtroCapacidad').value;
        const esOrdenadores = document.getElementById('filtroOrdenadores').value;
        let url = `${API_URL()}/aulas`;
        const params = new URLSearchParams();
        if (capacidad) params.append('capacidad', capacidad);
        if (esOrdenadores) params.append('esOrdenadores', esOrdenadores);
        if (params.toString()) url += `?${params.toString()}`;

        const container = document.getElementById('aulasList');
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Cargando aulas...</p>';

        try {
            const response = await fetch(url);
            console.log(response)
            if (!response.ok) {
                const err = await safeText(response);
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No se pudieron cargar las aulas</p>';
                showNotification(`Error al cargar las aulas: ${err || response.status}`, 'error');
                return;
            }
            let aulas = await safeJson(response);
            console.log(typeof aulas)
            if (!Array.isArray(aulas)) aulas = [];
            // actualizar caché de aulas para usos futuros
            aulasData = aulas;
            displayAulas(aulas);
        } catch (error) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Error al cargar las aulas</p>';
            showNotification('Error al cargar las aulas', 'error');
        }
    }

    function displayAulas(aulas) {
        const container = document.getElementById('aulasList');
        if (!aulas || aulas.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay aulas disponibles</p>';
            return;
        }
        container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Capacidad</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ordenadores</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${aulas.map(aula => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${aula.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${aula.nombre}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${aula.capacidad}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${aula.esOrdenadores ? 'Sí' : 'No'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button onclick="editAula(${aula.id})" class="text-blue-600 hover:text-blue-800">Editar</button>
                                    <button onclick="showReservasAula(${aula.id})" class="text-green-600 hover:text-green-800">Reservas</button>
                                    <button onclick="confirmDelete('aula', ${aula.id})" class="text-red-600 hover:text-red-800">Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
    }

    document.getElementById('aulaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('aulaId').value;
        const aula = {
            nombre: document.getElementById('aulaNombre').value,
            capacidad: parseInt(document.getElementById('aulaCapacidad').value, 10),
            esOrdenadores: document.getElementById('aulaEsOrdenadores').checked
        };
        try {
            const url = id ? `${API_URL()}/aulas/${id}` : `${API_URL()}/aulas`;
            const method = id ? 'PUT' : 'POST';
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(aula) });

            const rawBody = await safeText(response);
            let parsedBody = null;
            try { parsedBody = rawBody ? JSON.parse(rawBody) : null; } catch (err) { parsedBody = rawBody; }

            console.group('aulaForm response debug');
            console.log('REQUEST ->', { url, method, body: aula });
            console.log('RESPONSE status:', response.status, response.statusText);
            console.log('RESPONSE headers:');
            for (const pair of response.headers.entries()) console.log(pair[0] + ':', pair[1]);
            console.log('RESPONSE body (parsed):', parsedBody);
            console.log('RESPONSE body (raw):', rawBody);
            console.groupEnd();

            if (response.ok) {
                showNotification(id ? 'Aula actualizada correctamente' : 'Aula creada correctamente', 'success');
                clearAulaForm();
                // recargar aulas + actualizar caché
                setTimeout(loadAulas, 150);
            } else {
                const message = parsedBody && (parsedBody.message || parsedBody.error) ? (parsedBody.message || parsedBody.error) : (rawBody || `Código ${response.status}`);
                showNotification(`Error al guardar: ${message}`, 'error');
            }
        } catch (error) {
            console.error(error);
            showNotification('Error al guardar el aula (problema de conexión)', 'error');
        }
    });

    async function editAula(id) {
        try {
            const response = await fetch(`${API_URL()}/aulas/${id}`);
            if (!response.ok) throw new Error('No se pudo obtener el aula');
            const aula = await safeJson(response) || {};
            document.getElementById('aulaId').value = aula.id || '';
            document.getElementById('aulaNombre').value = aula.nombre || '';
            document.getElementById('aulaCapacidad').value = aula.capacidad || '';
            document.getElementById('aulaEsOrdenadores').checked = Boolean(aula.esOrdenadores);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (error) {
            showNotification('Error al cargar el aula', 'error');
        }
    }

    async function showReservasAula(aulaId) {
        try {
            const response = await fetch(`${API_URL()}/aulas/${aulaId}/reservas`);
            if (!response.ok) { showNotification('Error al cargar las reservas del aula', 'error'); return; }
            const reservas = await safeJson(response) || [];
            showTab('reservas');
            displayReservas(reservas);
            showNotification(`Mostrando reservas del aula ${aulaId}`, 'info');
        } catch (error) {
            showNotification('Error al cargar las reservas del aula', 'error');
        }
    }

    function clearAulaForm() { document.getElementById('aulaForm').reset(); document.getElementById('aulaId').value = ''; }
    function clearFilters() { document.getElementById('filtroCapacidad').value = ''; document.getElementById('filtroOrdenadores').value = ''; loadAulas(); }

    // -------------------------
    // CRUD HORARIOS
    // -------------------------
    async function loadHorarios() {
        try {
            const response = await fetch(`${API_URL()}/horarios`);
            if (!response.ok) { showNotification('Error al cargar los horarios', 'error'); document.getElementById('horariosList').innerHTML = '<p class="text-gray-500 text-center py-4">No hay horarios disponibles</p>'; return; }
            const horarios = await safeJson(response) || [];
            horariosData = horarios;
            displayHorarios(horariosData);
        } catch (error) {
            showNotification('Error al cargar los horarios', 'error');
        }
    }
    function displayHorarios(horarios) {
        const container = document.getElementById('horariosList');
        if (!horarios || horarios.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay horarios disponibles</p>'; return; }
        container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Día Semana</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hora Inicio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hora Fin</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${horarios.map(horario => `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${horario.id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${horario.diaSemana}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${horario.horaInicio}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${horario.horaFin}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button onclick="editHorario(${horario.id})" class="text-blue-600 hover:text-blue-800">Editar</button>
                                    <button onclick="confirmDelete('horario', ${horario.id})" class="text-red-600 hover:text-red-800">Eliminar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
    }

    document.getElementById('horarioForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('horarioId').value;
        const horario = {
            diaSemana: document.getElementById('horarioDiaSemana').value,
            horaInicio: document.getElementById('horarioHoraInicio').value,
            horaFin: document.getElementById('horarioHoraFin').value
        };
        try {
            const url = id ? `${API_URL()}/horarios/${id}` : `${API_URL()}/horarios`;
            const method = id ? 'PUT' : 'POST';
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(horario) });
            const raw = await safeText(response);
            if (response.ok) { showNotification(id ? 'Horario actualizado correctamente' : 'Horario creado correctamente', 'success'); clearHorarioForm(); loadHorarios(); }
            else { showNotification(`Error al guardar: ${raw || response.status}`, 'error'); }
        } catch (error) { showNotification('Error al guardar el horario', 'error'); }
    });

    async function editHorario(id) {
        try {
            const response = await fetch(`${API_URL()}/horarios/${id}`);
            if (!response.ok) throw new Error('No se pudo obtener el horario');
            const horario = await safeJson(response) || {};
            document.getElementById('horarioId').value = horario.id || '';
            document.getElementById('horarioDiaSemana').value = horario.diaSemana || 'LUNES';
            document.getElementById('horarioHoraInicio').value = horario.horaInicio || '';
            document.getElementById('horarioHoraFin').value = horario.horaFin || '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (error) { showNotification('Error al cargar el horario', 'error'); }
    }
    function clearHorarioForm() { document.getElementById('horarioForm').reset(); document.getElementById('horarioId').value = ''; }

    // -------------------------
    // CRUD RESERVAS
    // -------------------------
    async function loadReservas() {
        try {
            const response = await fetch(`${API_URL()}/reservas`);
            if (!response.ok) { showNotification('Error al cargar las reservas', 'error'); document.getElementById('reservasList').innerHTML = '<p class="text-gray-500 text-center py-4">No hay reservas</p>'; return; }
            const reservas = await safeJson(response) || [];
            displayReservas(reservas);
        } catch (error) { showNotification('Error al cargar las reservas', 'error'); }
    }

    function displayReservas(reservas) {
        const container = document.getElementById('reservasList');
        if (!reservas || reservas.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay reservas</p>'; return; }
        container.innerHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aula</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Horario</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Asistentes</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motivo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${reservas.map(r => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.aula?.nombre || r.aulaId || '—'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.horario?.diaSemana || r.horarioId || '—'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.fecha}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.asistentes}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${r.motivo}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                <button onclick="editReserva(${r.id})" class="text-blue-600 hover:text-blue-800">Editar</button>
                                <button onclick="confirmDelete('reserva', ${r.id})" class="text-red-600 hover:text-red-800">Eliminar</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    // --- load selects: guardan la caché ---
    async function loadAulasForSelect() {
        try {
            const response = await fetch(`${API_URL()}/aulas`);
            if (!response.ok) { showNotification('Error al cargar aulas para el select', 'error'); return; }
            const aulas = await safeJson(response) || [];
            aulasData = aulas;
            const select = document.getElementById('reservaAulaId');
            select.innerHTML = '<option value="">Seleccione un aula</option>' + (aulas.map(a => `<option value="${a.id}">${a.nombre} (cap.${a.capacidad})</option>`).join(''));
        } catch (error) { showNotification('Error al cargar aulas para el select', 'error'); }
    }

    async function loadHorariosForSelect() {
        try {
            const response = await fetch(`${API_URL()}/horarios`);
            if (!response.ok) { showNotification('Error al cargar horarios para el select', 'error'); return; }
            const horarios = await safeJson(response) || [];
            horariosData = horarios;
            const select = document.getElementById('reservaHorarioId');
            select.innerHTML = '<option value="">Seleccione un horario</option>' + (horariosData.map(h => `<option value="${h.id}">${h.diaSemana} ${h.horaInicio}-${h.horaFin}</option>`).join(''));
        } catch (error) { showNotification('Error al cargar horarios para el select', 'error'); }
    }

    // --- Envío de reservas (envía objetos completos aula y horario si están en caché) ---
    document.getElementById('reservaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('reservaId').value;

        const aulaIdSelected = parseInt(document.getElementById('reservaAulaId').value);
        const horarioIdSelected = parseInt(document.getElementById('reservaHorarioId').value);

        const aulaObj = aulasData.find(a => a.id === aulaIdSelected) || null;
        const horarioObj = horariosData.find(h => h.id === horarioIdSelected) || null;

        const reserva = {
            fecha: document.getElementById('reservaFecha').value,
            asistentes: parseInt(document.getElementById('reservaAsistentes').value, 10),
            motivo: document.getElementById('reservaMotivo').value
        };

        if (aulaObj) reserva.aula = aulaObj;
        else {
            const aid = parseInt(document.getElementById('reservaAulaId').value);
            if (!isNaN(aid)) reserva.aulaId = aid;
        }

        if (horarioObj) reserva.horario = horarioObj;
        else {
            const hid = parseInt(document.getElementById('reservaHorarioId').value);
            if (!isNaN(hid)) reserva.horarioId = hid;
        }

        try {
            const url = id ? `${API_URL()}/reservas/${id}` : `${API_URL()}/reservas`;
            const method = id ? 'PUT' : 'POST';
            const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reserva) });

            const raw = await safeText(response);
            let parsed = null;
            try { parsed = raw ? JSON.parse(raw) : null; } catch (e) { parsed = raw; }

            console.group('reservaForm response debug');
            console.log('REQUEST ->', { url, method, body: reserva });
            console.log('RESPONSE status:', response.status, response.statusText);
            console.log('RESPONSE body (parsed):', parsed);
            console.log('RESPONSE body (raw):', raw);
            console.groupEnd();

            if (response.ok) {
                showNotification(id ? 'Reserva actualizada correctamente' : 'Reserva creada correctamente', 'success');
                clearReservaForm();
                setTimeout(loadReservas, 150);
            } else {
                showNotification(`Error al guardar la reserva: ${raw || response.status}`, 'error');
            }
        } catch (error) {
            console.error('Error guardando reserva:', error);
            showNotification('Error al guardar la reserva (conexión)', 'error');
        }
    });

    // --- Edit reserva: carga y rellena selects (usa la caché) ---
    async function editReserva(id) {
        try {
            const response = await fetch(`${API_URL()}/reservas/${id}`);
            if (!response.ok) throw new Error('No se pudo obtener la reserva');
            const r = await safeJson(response) || {};

            document.getElementById('reservaId').value = r.id || '';
            const aid = (r.aula && r.aula.id) ? r.aula.id : (r.aulaId || '');
            const hid = (r.horario && r.horario.id) ? r.horario.id : (r.horarioId || '');

            await loadAulasForSelect();
            await loadHorariosForSelect();

            document.getElementById('reservaAulaId').value = aid || '';
            document.getElementById('reservaHorarioId').value = hid || '';
            document.getElementById('reservaFecha').value = r.fecha || '';
            document.getElementById('reservaAsistentes').value = r.asistentes || '';
            document.getElementById('reservaMotivo').value = r.motivo || '';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (error) {
            showNotification('Error al cargar la reserva', 'error');
        }
    }

    function clearReservaForm() { document.getElementById('reservaForm').reset(); document.getElementById('reservaId').value = ''; document.getElementById('reservaFecha').value = ''; }

    // --- Confirm / delete ---
    function confirmDelete(type, id) {
        const modal = document.getElementById('confirmModal');
        modal.classList.remove('hidden');
        const btn = document.getElementById('confirmDelete');
        btn.dataset.type = type;
        btn.dataset.id = id;
    }
    function closeModal() {
        const modal = document.getElementById('confirmModal');
        modal.classList.add('hidden');
        const btn = document.getElementById('confirmDelete');
        delete btn.dataset.type;
        delete btn.dataset.id;
    }
    document.getElementById('confirmDelete').addEventListener('click', async function () {
        const type = this.dataset.type;
        const id = this.dataset.id;
        if (!type || !id) return closeModal();
        try {
            const url = `${API_URL()}/${type}s/${id}`;
            const response = await fetch(url, { method: 'DELETE' });
            const raw = await safeText(response);
            if (response.ok) {
                showNotification('Eliminado correctamente', 'success');
                closeModal();
                if (type === 'aula') loadAulas();
                if (type === 'horario') loadHorarios();
                if (type === 'reserva') loadReservas();
            } else {
                showNotification(`Error al eliminar: ${raw || response.status}`, 'error');
                closeModal();
            }
        } catch (error) {
            showNotification('Error al eliminar', 'error');
            closeModal();
        }
    });

    // --- Inicialización ---
    document.addEventListener('DOMContentLoaded', () => showTab('aulas'));
</script>
</body>
</html>
